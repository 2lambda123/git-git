name: but-l10n

on: [push, pull_request_target]

jobs:
  but-po-helper:
    if: >-
      endsWith(buthub.repository, '/but-po') ||
      contains(buthub.head_ref, 'l10n') ||
      contains(buthub.ref, 'l10n')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Setup base and head objects
        id: setup-tips
        run: |
          if test "${{ buthub.event_name }}" = "pull_request_target"
          then
            base=${{ buthub.event.pull_request.base.sha }}
            head=${{ buthub.event.pull_request.head.sha }}
          else
            base=${{ buthub.event.before }}
            head=${{ buthub.event.after }}
          fi
          echo "::set-output name=base::$base"
          echo "::set-output name=head::$head"
      - name: Run partial clone
        run: |
          but -c init.defaultBranch=master init --bare .
          but remote add \
            --mirror=fetch \
            origin \
            https://buthub.com/${{ buthub.repository }}
          # Fetch tips that may be unreachable from buthub.ref:
          # - For a forced push, "$base" may be unreachable.
          # - For a "pull_request_target" event, "$head" may be unreachable.
          args=
          for cummit in \
            ${{ steps.setup-tips.outputs.base }} \
            ${{ steps.setup-tips.outputs.head }}
          do
            case $cummit in
            *[^0]*)
              args="$args $cummit"
              ;;
            *)
              # Should not fetch ZERO-OID.
              ;;
            esac
          done
          but -c protocol.version=2 fetch \
            --progress \
            --no-tags \
            --no-write-fetch-head \
            --filter=blob:none \
            origin \
            ${{ buthub.ref }} \
            $args
      - uses: actions/setup-go@v2
        with:
          go-version: '>=1.16'
      - name: Install but-po-helper
        run: go install buthub.com/but-l10n/but-po-helper@main
      - name: Install other dependencies
        run: |
          sudo apt-get update -q &&
          sudo apt-get install -q -y gettext
      - name: Run but-po-helper
        id: check-cummits
        run: |
          exit_code=0
          but-po-helper check-cummits \
            --buthub-action-event="${{ buthub.event_name }}" -- \
            ${{ steps.setup-tips.outputs.base }}..${{ steps.setup-tips.outputs.head }} \
            >but-po-helper.out 2>&1 || exit_code=$?
          if test $exit_code -ne 0 || grep -q WARNING but-po-helper.out
          then
            # Remove ANSI colors which are proper for console logs but not
            # proper for PR comment.
            echo "COMMENT_BODY<<EOF" >>$BUTHUB_ENV
            perl -pe 's/\e\[[0-9;]*m//g; s/\bEOF$//g' but-po-helper.out >>$BUTHUB_ENV
            echo "EOF" >>$BUTHUB_ENV
          fi
          cat but-po-helper.out
          exit $exit_code
      - name: Create comment in pull request for report
        uses: mshick/add-pr-comment@v1
        if: >-
          always() &&
          buthub.event_name == 'pull_request_target' &&
          env.COMMENT_BODY != ''
        with:
          repo-token: ${{ secrets.BUTHUB_TOKEN }}
          repo-token-user-login: 'buthub-actions[bot]'
          message: >
            ${{ steps.check-cummits.outcome == 'failure' && 'Errors and warnings' || 'Warnings' }}
            found by [but-po-helper](https://buthub.com/but-l10n/but-po-helper#readme) in workflow
            [#${{ buthub.run_number }}](${{ env.BUTHUB_SERVER_URL }}/${{ buthub.repository }}/actions/runs/${{ buthub.run_id }}):

            ```

            ${{ env.COMMENT_BODY }}

            ```
